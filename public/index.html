<body>
  <div class="container">
    <div class="header">
      <div class="user-section">
        <div class="avatar"></div>
        <div class="user-info">
          <div class="name">Имя Фамилия</div>
          <div class="username">@nickname</div>
        </div>
      </div>
      <div class="title">Task</div>
    </div>
    <div class="date-container">
      <div class="date-select" id="monthDisplay">
        <span id="monthText">Март 2025</span>
        <div class="icon-container">
          <svg width="12" height="12" viewBox="0 0 16 16" fill="#1e1e1e">
            <path d="M8 10L4 6h8l-4 4z" />
          </svg>
        </div>
      </div>
      <div class="day-select">
        <div class="icon-container" id="prevDay">
          <svg width="12" height="12" viewBox="0 0 16 16" fill="#1e1e1e">
            <path d="M6 8l4 4V4l-4 4z" />
          </svg>
        </div>
        <span id="currentDay">Сегодня</span>
        <div class="icon-container" id="nextDay">
          <svg width="12" height="12" viewBox="0 0 16 16" fill="#1e1e1e">
            <path d="M10 8L6 4v8l4-4z" />
          </svg>
        </div>
      </div>
    </div>
    <input type="date" id="datePicker" style="display:none;">
    <div class="tabs" id="tabsContainer"></div>
    <div class="task-list" id="taskList"></div>
    <div class="add-button">
      <button id="addTaskBtn">Добавить задачу</button>
    </div>
    <div class="backdrop" id="backdrop"></div>
    <div class="task-form" id="taskForm">
      <div class="header-form">
        <div class="title" id="modalTaskTitle">Задача</div>
        <div class="close" id="closeModalBtn">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
            <path d="M1 1L11 11M11 1L1 11" stroke="#757575" stroke-width="2"/>
          </svg>
        </div>
      </div>
      <div class="form-row task-input-row">
        <input type="text" id="modalTaskInput" placeholder="Название задачи" />
        <button class="complete-btn" id="modalCompleteBtn">Выполнить</button>
      </div>
      <div class="form-row">
        <textarea id="modalTaskDesc" placeholder="Описание"></textarea>
      </div>
      <div class="form-row">
        <input type="date" id="modalTaskDate" />
      </div>
      <div class="form-row">
        <input type="time" id="modalTaskTime" />
      </div>
      <div class="form-row reminder-row">
        <span class="reminder-label">Напомнить за час</span>
        <label class="toggle-switch">
          <input type="checkbox" id="modalTaskReminder">
          <span class="slider"></span>
        </label>
      </div>
      <div class="form-row priority-row">
        <span class="priority-label">Приоритет</span>
        <select id="modalTaskPriority">
          <option value="High">Высокий</option>
          <option value="Medium" selected>Средний</option>
          <option value="Low">Низкий</option>
        </select>
      </div>
      <div class="form-row">
        <button class="submit-button" id="modalSubmitBtn">Сохранить задачу</button>
      </div>
    </div>
  </div>
  
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    try {
      Telegram.WebApp.ready();
      console.log('Telegram WebApp initialized');
    } catch (error) {
      console.error('Telegram WebApp initialization failed:', error);
    }

    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing app...');

      function formatDate(date) {
        let d = new Date(date);
        let month = '' + (d.getMonth() + 1);
        let day = '' + d.getDate();
        let year = d.getFullYear();
        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;
        return [year, month, day].join('-');
      }

      function getWeekDates(selectedDate) {
        let date = new Date(selectedDate);
        let day = date.getDay();
        let diff = (day === 0 ? -6 : 1 - day);
        let monday = new Date(date);
        monday.setDate(date.getDate() + diff);
        let weekDates = [];
        for(let i = 0; i < 7; i++) {
          let d = new Date(monday);
          d.setDate(monday.getDate() + i);
          weekDates.push(d);
        }
        return weekDates;
      }

      function updateTabs(selectedDate) {
        const tabsContainer = document.getElementById('tabsContainer');
        if (!tabsContainer) {
          console.error('tabsContainer not found');
          return;
        }
        tabsContainer.innerHTML = '';
        let weekDates = getWeekDates(selectedDate);
        weekDates.forEach(function(date) {
          let tab = document.createElement('div');
          tab.className = 'tab';
          let dayNames = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
          let dayName = dayNames[date.getDay()];
          let dayNum = date.getDate();
          tab.innerHTML = dayName + '<br>' + dayNum;
          tab.dataset.date = formatDate(date);
          tab.addEventListener('click', function() {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            let today = formatDate(new Date());
            if (tab.dataset.date === today) {
              document.getElementById('currentDay').textContent = 'Сегодня';
            } else {
              document.getElementById('currentDay').textContent = dayName + '. ' + dayNum;
            }
            currentSelectedDate = new Date(tab.dataset.date);
            updateMonthDisplay(currentSelectedDate);
            updateCurrentDayLabel();
            loadTasks();
          });
          if (formatDate(date) === formatDate(selectedDate)) {
            tab.classList.add('active');
          }
          tabsContainer.appendChild(tab);
        });
      }

      let currentSelectedDate = new Date();
      function updateMonthDisplay(date) {
        const monthText = document.getElementById('monthText');
        if (!monthText) {
          console.error('monthText not found');
          return;
        }
        const options = { month: 'long', year: 'numeric' };
        monthText.textContent = date.toLocaleDateString('ru-RU', options);
      }

      updateMonthDisplay(currentSelectedDate);
      updateTabs(currentSelectedDate);

      const monthDisplay = document.getElementById('monthDisplay');
      if (monthDisplay) {
        monthDisplay.addEventListener('click', function() {
          document.getElementById('datePicker').click();
        });
      }

      const datePicker = document.getElementById('datePicker');
      if (datePicker) {
        datePicker.addEventListener('change', function() {
          let selected = new Date(this.value);
          currentSelectedDate = selected;
          updateMonthDisplay(selected);
          updateTabs(selected);
          updateCurrentDayLabel();
          loadTasks();
        });
      }

      const prevDay = document.getElementById('prevDay');
      if (prevDay) {
        prevDay.addEventListener('click', function(e) {
          e.stopPropagation();
          currentSelectedDate.setDate(currentSelectedDate.getDate() - 1);
          updateMonthDisplay(currentSelectedDate);
          updateTabs(currentSelectedDate);
          updateCurrentDayLabel();
          loadTasks();
        });
      }

      const nextDay = document.getElementById('nextDay');
      if (nextDay) {
        nextDay.addEventListener('click', function(e) {
          e.stopPropagation();
          currentSelectedDate.setDate(currentSelectedDate.getDate() + 1);
          updateMonthDisplay(currentSelectedDate);
          updateTabs(currentSelectedDate);
          updateCurrentDayLabel();
          loadTasks();
        });
      }

      function updateCurrentDayLabel() {
        const dayNames = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
        const dayName = dayNames[currentSelectedDate.getDay()];
        const dayNum = currentSelectedDate.getDate();
        const today = formatDate(new Date());
        const currentDay = document.getElementById('currentDay');
        if (currentDay) {
          if (formatDate(currentSelectedDate) === today) {
            currentDay.textContent = 'Сегодня';
          } else {
            currentDay.textContent = dayName + '. ' + dayNum;
          }
        }
      }

      let currentTaskItem = null;
      function openModal(taskItem) {
        console.log('Opening modal...');
        const modal = document.getElementById('taskForm');
        const backdrop = document.getElementById('backdrop');
        if (!modal || !backdrop) {
          console.error('Modal or backdrop not found');
          return;
        }
        currentTaskItem = taskItem;
        modal.classList.add('active');
        backdrop.classList.add('active');
        if (taskItem) {
          document.getElementById('modalTaskTitle').textContent = taskItem.dataset.title;
          document.getElementById('modalTaskInput').value = taskItem.dataset.title;
          document.getElementById('modalTaskDesc').value = taskItem.dataset.description || '';
          document.getElementById('modalTaskDate').value = taskItem.dataset.date;
          document.getElementById('modalTaskTime').value = taskItem.dataset.time || '';
          document.getElementById('modalTaskReminder').checked = (taskItem.dataset.reminder === "true");
          document.getElementById('modalTaskPriority').value = taskItem.dataset.priority;
          document.getElementById('modalCompleteBtn').textContent = taskItem.dataset.completed === "true" ? "Вернуть" : "Выполнить";
        } else {
          document.getElementById('modalTaskTitle').textContent = "Новая задача";
          document.getElementById('modalTaskInput').value = "";
          document.getElementById('modalTaskDesc').value = "";
          document.getElementById('modalTaskDate').value = formatDate(new Date());
          document.getElementById('modalTaskTime').value = "";
          document.getElementById('modalTaskReminder').checked = false;
          document.getElementById('modalTaskPriority').value = "Medium";
          document.getElementById('modalCompleteBtn').textContent = "Выполнить";
        }
      }

      function closeModal() {
        console.log('Closing modal...');
        const modal = document.getElementById('taskForm');
        const backdrop = document.getElementById('backdrop');
        if (!modal || !backdrop) {
          console.error('Modal or backdrop not found');
          return;
        }
        modal.classList.add('closing');
        setTimeout(() => {
          modal.classList.remove('active', 'closing');
          backdrop.classList.remove('active');
        }, 300);
      }

      const addTaskBtn = document.getElementById('addTaskBtn');
      if (addTaskBtn) {
        addTaskBtn.addEventListener('click', function() {
          console.log('Add task button clicked');
          openModal(null);
        });
      } else {
        console.error('addTaskBtn not found');
      }

      const closeModalBtn = document.getElementById('closeModalBtn');
      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeModal);
      } else {
        console.error('closeModalBtn not found');
      }

      const backdrop = document.getElementById('backdrop');
      if (backdrop) {
        backdrop.addEventListener('click', closeModal);
      }

      const modalTaskInput = document.getElementById('modalTaskInput');
      if (modalTaskInput) {
        modalTaskInput.addEventListener('input', function() {
          document.getElementById('modalTaskTitle').textContent = this.value || 'Задача';
        });
      }

      const modalCompleteBtn = document.getElementById('modalCompleteBtn');
      if (modalCompleteBtn) {
        modalCompleteBtn.addEventListener('click', function() {
          if (currentTaskItem) {
            let isCompleted = (currentTaskItem.dataset.completed === "true");
            if (isCompleted) {
              currentTaskItem.dataset.completed = "false";
              currentTaskItem.querySelector('.checkbox').classList.remove('checked');
              currentTaskItem.querySelector('.task-title').style.color = "#1e1e1e";
              currentTaskItem.querySelector('.task-date').style.color = "#757575";
              this.textContent = "Выполнить";
            } else {
              currentTaskItem.dataset.completed = "true";
              currentTaskItem.querySelector('.checkbox').classList.add('checked');
              currentTaskItem.querySelector('.task-title').style.color = "#D9D9D9";
              currentTaskItem.querySelector('.task-date').style.color = "#D9D9D9";
              this.textContent = "Вернуть";
            }
          }
          closeModal();
        });
      }

      const modalSubmitBtn = document.getElementById('modalSubmitBtn');
      if (modalSubmitBtn) {
        modalSubmitBtn.addEventListener('click', async function() {
          console.log('Submit button clicked');
          const titleInput = document.getElementById('modalTaskInput');
          const dateInput = document.getElementById('modalTaskDate');
          if (!titleInput.value.trim()) {
            titleInput.style.borderColor = '#BD0935';
            titleInput.focus();
            return;
          }
          if (new Date(dateInput.value) < new Date().setHours(0,0,0,0)) {
            dateInput.style.borderColor = '#BD0935';
            return;
          }

          const title = titleInput.value.trim();
          const description = document.getElementById('modalTaskDesc').value;
          const date = dateInput.value;
          const time = document.getElementById('modalTaskTime').value;
          const deadline = date && time ? `${date}T${time}:00` : date ? `${date}T00:00:00` : null;
          const priority = document.getElementById('modalTaskPriority').value;
          const reminder = document.getElementById('modalTaskReminder').checked;

          if (currentTaskItem) {
            currentTaskItem.dataset.title = title;
            currentTaskItem.dataset.description = description;
            currentTaskItem.dataset.date = date;
            currentTaskItem.dataset.time = time;
            currentTaskItem.dataset.priority = priority;
            currentTaskItem.dataset.reminder = reminder;
            currentTaskItem.querySelector('.task-title').textContent = title;
            currentTaskItem.querySelector('.task-date').textContent = deadline ? new Date(deadline).toLocaleString('ru-RU', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }) : 'Без даты';
            const priorityDiv = currentTaskItem.querySelector('.priority');
            priorityDiv.className = 'priority';
            if (priority === 'High') priorityDiv.classList.add('priority-high');
            else if (priority === 'Medium') priorityDiv.classList.add('priority-medium');
            else priorityDiv.classList.add('priority-low');
            priorityDiv.textContent = priority;
          } else {
            try {
              const response = await fetch('https://task-manager-tj38.onrender.com/tasks', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  title: title,
                  description: description,
                  deadline: deadline,
                  priority: priority,
                  reminder: reminder,
                  completed: false
                })
              });
              if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Ошибка ${response.status}: ${errorText}`);
              }
              const newTask = await response.json();
              visibleTasks.push(newTask);
              renderTasks();
            } catch (error) {
              console.error('Ошибка при создании задачи:', error);
              alert(`Не удалось создать задачу: ${error.message}`);
            }
          }
          closeModal();
        });
      }

      const visibleTasks = [];
      const taskList = document.getElementById('taskList');

      function createTaskElement(task) {
        const taskItem = document.createElement('div');
        taskItem.className = 'task-item';
        taskItem.setAttribute('data-id', task.id);
        taskItem.setAttribute('data-title', task.title);
        taskItem.setAttribute('data-description', task.description || '');
        taskItem.setAttribute('data-date', task.deadline ? task.deadline.split('T')[0] : '');
        taskItem.setAttribute('data-time', task.deadline ? task.deadline.split('T')[1]?.slice(0, 5) : '');
        taskItem.setAttribute('data-priority', task.priority);
        taskItem.setAttribute('data-reminder', task.reminder || false);
        taskItem.setAttribute('data-completed', task.completed || false);

        const checkbox = document.createElement('div');
        checkbox.className = 'checkbox';
        if (task.completed) checkbox.classList.add('checked');
        checkbox.addEventListener('click', function(event) {
          event.stopPropagation();
          taskItem.classList.toggle('completed');
          checkbox.classList.toggle('checked');
        });
        const inner = document.createElement('div');
        inner.className = 'inner';
        checkbox.appendChild(inner);

        const taskInfo = document.createElement('div');
        taskInfo.className = 'task-info';
        const titleElem = document.createElement('div');
        titleElem.className = 'task-title';
        titleElem.textContent = task.title;
        const dateElem = document.createElement('div');
        dateElem.className = 'task-date';
        dateElem.textContent = task.deadline ? new Date(task.deadline).toLocaleString('ru-RU', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }) : 'Без даты';
        taskInfo.appendChild(titleElem);
        taskInfo.appendChild(dateElem);

        const priorityElem = document.createElement('div');
        priorityElem.className = 'priority';
        if (task.priority === 'High') priorityElem.classList.add('priority-high');
        else if (task.priority === 'Medium') priorityElem.classList.add('priority-medium');
        else priorityElem.classList.add('priority-low');
        priorityElem.textContent = task.priority;

        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = 'Удалить';
        deleteBtn.addEventListener('click', async function(event) {
          event.stopPropagation();
          const taskId = task.id;
          try {
            const response = await fetch(`https://task-manager-tj38.onrender.com/tasks/${taskId}`, {
              method: 'DELETE',
            });
            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`Ошибка ${response.status}: ${errorText}`);
            }
            const index = visibleTasks.findIndex(t => t.id === taskId);
            if (index !== -1) visibleTasks.splice(index, 1);
            renderTasks();
          } catch (error) {
            console.error('Ошибка при удалении задачи:', error);
            alert(`Не удалось удалить задачу: ${error.message}`);
          }
        });

        taskItem.appendChild(checkbox);
        taskItem.appendChild(taskInfo);
        taskItem.appendChild(priorityElem);
        taskItem.appendChild(deleteBtn);

        taskItem.addEventListener('click', function() {
          openModal(taskItem);
        });

        return taskItem;
      }

      function renderTasks() {
        if (!taskList) {
          console.error('taskList not found');
          return;
        }
        taskList.innerHTML = '';
        visibleTasks.forEach(task => {
          taskList.appendChild(createTaskElement(task));
        });
      }

      async function loadTasks() {
        try {
          const selectedDate = formatDate(currentSelectedDate);
          const response = await fetch(`https://task-manager-tj38.onrender.com/tasks?date=${selectedDate}`);
          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Ошибка ${response.status}: ${errorText}`);
          }
          const tasks = await response.json();
          visibleTasks.length = 0;
          tasks.forEach(task => visibleTasks.push(task));
          renderTasks();
          console.log('Tasks loaded:', tasks);
        } catch (error) {
          console.error('Ошибка при загрузке задач:', error);
          alert(`Не удалось загрузить задачи: ${error.message}`);
        }
      }

      loadTasks();
    });
  </script>
</body>
