<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Task Manager Mini App</title>
  <style>
    /* Стили для кнопки удаления */
    .delete-btn {
      padding: 4px 8px;
      background: #BD0935;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-left: 8px;
    }
    .delete-btn:hover {
      background: #A0072F;
    }
    /* Основные стили */
    @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap');
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Manrope', Arial, sans-serif; }
    body {
      padding: 0;
      background: var(--tg-theme-secondary-bg-color, #f4f4f4);
      color: var(--tg-theme-text-color, #1e1e1e);
      min-height: 100vh;
      display: flex;
      justify-content: center;
    }
    .container { width: 100%; max-width: 100%; border-radius: 0; height: 100vh; overflow: hidden; box-shadow: none; background: var(--tg-theme-bg-color, #ffffff); position: relative; }
    .header { height: 80px; background: var(--tg-theme-bg-color, #ffffff); display: flex; justify-content: space-between; align-items: center; padding: 16px; }
    .user-section { display: flex; align-items: center; }
    .avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 12px;
      background-size: cover;
      background-position: center;
      background-color: transparent;
    }
    .user-info .name { font-size: 18px; font-weight: 600; color: #1e1e1e; }
    .user-info .username { font-size: 14px; font-weight: 500; color: #757575; }
    .header .title { font-size: 20px; font-weight: 600; color: #1e1e1e; }
    .date-container { padding: 16px; display: flex; justify-content: space-between; align-items: center; gap: 16px; }
    .date-select, .day-select { height: 32px; border: 1px solid #d9d9d9; border-radius: 8px; display: flex; align-items: center; font-size: 16px; color: #1e1e1e; cursor: pointer; flex: 1; }
    .date-select { padding: 0 8px; justify-content: space-between; }
    .day-select { padding: 0 8px; justify-content: space-between; }
    .date-select span, .day-select span { white-space: nowrap; }
    .date-select .icon-container, .day-select .icon-container { width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; }
    .date-select .icon-container svg, .day-select .icon-container svg { width: 12px; height: 12px; }
    .tabs { display: flex; padding: 8px 16px; overflow-x: auto; scrollbar-width: none; -ms-overflow-style: none; position: relative; }
    .tabs::after { content: ''; position: absolute; right: 0; top: 0; width: 40px; height: 100%; background: linear-gradient(90deg, rgba(255,255,255,0) 0%, var(--tg-theme-bg-color, #ffffff) 100%); }
    .tabs::-webkit-scrollbar { display: none; }
    .tab { min-width: 40px; text-align: center; padding: 8px; margin-right: 8px; font-size: 14px; color: #757575; cursor: pointer; }
    .tab.active { color: #ff5722; font-weight: 600; border-bottom: 2px solid #ff5722; }
    .task-list { padding: 16px; }
    .task-item { display: flex; align-items: flex-start; padding: 12px 0; cursor: pointer; transition: all 0.2s ease; border-bottom: 1px solid rgba(0,0,0,0.05); }
    .task-item:hover { transform: translateX(4px); background: var(--tg-theme-secondary-bg-color, #f8f8f8); }
    .task-item.completed .task-title { text-decoration: line-through; opacity: 0.6; }
    .task-item.completed .task-date { color: #D9D9D9; }
    .task-item .checkbox {
      width: 16px;
      height: 16px;
      margin-right: 12px;
      margin-top: 2px;
      cursor: pointer;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      border: 2px solid #757575;
      border-radius: 50%;
      position: relative;
      background: transparent;
    }
    .task-item .checkbox:checked {
      border: 2px solid #1e1e1e;
      background: transparent;
    }
    .task-item .checkbox:checked::before {
      content: '';
      width: 8px;
      height: 8px;
      background: #1e1e1e;
      border-radius: 50%;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    .task-item .task-info { flex: 1; }
    .task-item .task-title { font-size: 16px; color: #1e1e1e; line-height: 140%; margin-bottom: 4px; }
    .task-item .task-date { font-size: 16px; color: #757575; line-height: 140%; }
    .task-item .priority { font-size: 14px; padding: 2px 8px; border-radius: 4px; margin-left: 8px; }
    .priority-high { color: #BD0935; background: rgba(255, 0, 61, 0.15); }
    .priority-medium { color: #BD5C0A; background: rgba(255, 190, 92, 0.3); }
    .priority-low { color: #2D8B5D; background: rgba(50, 186, 118, 0.15); }
    .add-button { 
      position: fixed; 
      bottom: 32px; 
      left: 50%; 
      transform: translateX(-50%); 
      z-index: 10; 
    }
    .add-button button { 
      display: inline-flex; 
      align-items: center; 
      justify-content: center; 
      height: 50px; 
      background: #2c2c2c; 
      color: #fff; 
      font-size: 16px; 
      font-weight: 600; 
      padding: 0 16px; 
      border-radius: 12px; 
      border: none; 
      cursor: pointer; 
      transition: background-color 0.2s; 
      white-space: nowrap; 
    }
    .add-button button:hover { 
      background-color: #1e1e1e; 
    }
    .backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.2); z-index: 999; }
    .backdrop.active { display: block; }
    .task-form { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); width: 300px; z-index: 1000; animation: moveIn 300ms ease-out forwards; }
    .task-form.active { display: block; }
    @keyframes moveIn { from { transform: translate(-50%, 100%); } to { transform: translate(-50%, -50%); } }
    @keyframes moveOut { from { transform: translate(-50%, -50%); } to { transform: translate(-50%, 100%); } }
    .task-form.closing { animation: moveOut 300ms ease-out forwards; }
    .task-form .header-form { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .task-form .header-form .title { font-size: 18px; font-weight: 600; color: #1e1e1e; }
    .task-form .header-form .close { width: 24px; height: 24px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    .task-form .header-form .close svg { fill: #757575; width: 12px; height: 12px; transition: fill 0.2s; }
    .task-form .header-form .close:hover svg { fill: #1e1e1e; }
    .task-form .form-row { margin-bottom: 12px; }
    .task-form .form-row.task-input-row { display: flex; align-items: center; gap: 12px; }
    .task-form .form-row input, .task-form .form-row textarea { width: 100%; padding: 8px; border: 1px solid #d9d9d9; border-radius: 8px; font-size: 14px; }
    .task-form .form-row input::placeholder, .task-form .form-row textarea::placeholder { color: #757575; opacity: 0.7; }
    .task-form .form-row textarea { height: 80px; resize: none; }
    .task-form .form-row .complete-btn { padding: 6px 12px; background: rgba(54,151,241,0.15); border: none; border-radius: 4px; font-size: 14px; font-weight: 500; color: #348BDC; cursor: pointer; transition: background-color 0.2s; flex-shrink: 0; }
    .task-form .form-row .complete-btn:hover { background-color: rgba(54,151,241,0.25); }
    .task-form .form-row.reminder-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
    .task-form .form-row.reminder-row .reminder-label { font-size: 14px; color: #757575; }
    .task-form .form-row .toggle-switch { position: relative; width: 40px; height: 24px; }
    .task-form .form-row .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .task-form .form-row .toggle-switch .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #d9d9d9; border-radius: 12px; transition: background-color 0.3s ease; }
    .task-form .form-row .toggle-switch .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: #fff; border-radius: 50%; transition: transform 0.3s ease; }
    .task-form .form-row .toggle-switch input:checked + .slider { background-color: #3697F1; }
    .task-form .form-row .toggle-switch input:checked + .slider:before { transform: translateX(16px); }
    .task-form .form-row.priority-row { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; }
    .task-form .form-row.priority-row .priority-label { font-size: 14px; color: #1e1e1e; }
    .task-form .form-row.priority-row select { flex: 1; padding: 8px; border: 1px solid #d9d9d9; border-radius: 8px; font-size: 14px; appearance: none; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 12 12"><path fill="%23757575" d="M2 4l4 4 4-4z"/></svg>') no-repeat right 8px center; }
    .task-form .form-row.priority-row select option { padding: 2px 8px; border-radius: 3px; font-size: 14px; background-color: #FFFFFF; }
    .task-form .form-row.priority-row select option[value="High"] { color: #BD0935; border: 1px solid rgba(255, 0, 61, 0.15); }
    .task-form .form-row.priority-row select option[value="Medium"] { color: #BD5C0A; border: 1px solid rgba(255, 190, 92, 0.3); }
    .task-form .form-row.priority-row select option[value="Low"] { color: #2D8B5D; border: 1px solid rgba(50, 186, 118, 0.15); }
    .task-form .submit-button { width: 100%; height: 50px; background: #2c2c2c; color: #fff; font-size: 16px; font-weight: 600; border: none; border-radius: 12px; cursor: pointer; transition: background-color 0.2s; }
    .task-form .submit-button:hover { background-color: #1e1e1e; }
    @media screen and (max-width: 401px) { .container { max-width: 315px; } .task-form { width: 280px; } }
  </style>
</head>
<body>
  <div class="container">
    <!-- Заголовок с информацией о пользователе и названием приложения -->
    <div class="header">
      <div class="user-section">
        <div class="avatar"></div>
        <div class="user-info">
          <div class="name">Имя Фамилия</div>
          <div class="username">@nickname</div>
        </div>
      </div>
      <div class="title">Task</div>
    </div>
    <!-- Контейнер для выбора даты -->
    <div class="date-container">
      <div class="date-select" id="monthDisplay">
        <span id="monthText">Март 2025</span>
        <div class="icon-container">
          <svg width="12" height="12" viewBox="0 0 16 16" fill="#1e1e1e">
            <path d="M8 10L4 6h8l-4 4z" />
          </svg>
        </div>
      </div>
      <div class="day-select">
        <div class="icon-container" id="prevDay">
          <svg width="12" height="12" viewBox="0 0 16 16" fill="#1e1e1e">
            <path d="M6 8l4 4V4l-4 4z" />
          </svg>
        </div>
        <span id="currentDay">Сегодня</span>
        <div class="icon-container" id="nextDay">
          <svg width="12" height="12" viewBox="0 0 16 16" fill="#1e1e1e">
            <path d="M10 8L6 4v8l4-4z" />
          </svg>
        </div>
      </div>
    </div>
    <!-- Скрытый input для выбора даты -->
    <input type="date" id="datePicker" style="display:none;">
    <!-- Вкладки с днями недели -->
    <div class="tabs" id="tabsContainer"></div>
    <!-- Список задач -->
    <div class="task-list" id="taskList"></div>
    <!-- Кнопка добавления задачи -->
    <div class="add-button">
      <button id="addTaskBtn">Добавить задачу</button>
    </div>
    <!-- Затемнение фона при открытии модального окна -->
    <div class="backdrop" id="backdrop"></div>
    <!-- Форма для создания/редактирования задачи -->
    <div class="task-form" id="taskForm">
      <div class="header-form">
        <div class="title" id="modalTaskTitle">Задача</div>
        <div class="close" id="closeModalBtn">
          <svg width="12" height="12" viewBox="0 0 12 12" fill="none">
            <path d="M1 1L11 11M11 1L1 11" stroke="#757575" stroke-width="2"/>
          </svg>
        </div>
      </div>
      <div class="form-row task-input-row">
        <input type="text" id="modalTaskInput" placeholder="Название задачи" />
        <button class="complete-btn" id="modalCompleteBtn">Выполнить</button>
      </div>
      <div class="form-row">
        <textarea id="modalTaskDesc" placeholder="Описание"></textarea>
      </div>
      <div class="form-row">
        <input type="date" id="modalTaskDate" />
      </div>
      <div class="form-row">
        <input type="time" id="modalTaskTime" />
      </div>
      <div class="form-row reminder-row">
        <span class="reminder-label">Напомнить за час</span>
        <label class="toggle-switch">
          <input type="checkbox" id="modalTaskReminder">
          <span class="slider"></span>
        </label>
      </div>
      <div class="form-row priority-row">
        <span class="priority-label">Приоритет</span>
        <select id="modalTaskPriority">
          <option value="High">Высокий</option>
          <option value="Medium" selected>Средний</option>
          <option value="Low">Низкий</option>
        </select>
      </div>
      <div class="form-row">
        <button class="submit-button" id="modalSubmitBtn">Сохранить задачу</button>
      </div>
    </div>
  </div>

  <!-- Подключение Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM loaded, initializing app...');

      // Инициализация Telegram WebApp и получение user_id
      let user_id;
      try {
        Telegram.WebApp.ready();
        const user = Telegram.WebApp.initDataUnsafe.user;
        if (user && user.id) {
          user_id = user.id; // Telegram ID пользователя для всех запросов к API
          const name = user.first_name + (user.last_name ? ' ' + user.last_name : '');
          const username = user.username ? '@' + user.username : 'No username';
          const avatar = user.photo_url || 'https://via.placeholder.com/40';
          document.querySelector('.name').textContent = name;
          document.querySelector('.username').textContent = username;
          document.querySelector('.avatar').style.backgroundImage = `url(${avatar})`;
          document.querySelector('.avatar').style.backgroundSize = 'cover';
          document.querySelector('.avatar').style.backgroundColor = 'transparent';
          console.log('Telegram WebApp initialized with user_id:', user_id);
        } else {
          throw new Error("Не удалось получить user_id из Telegram");
        }
      } catch (error) {
        console.error('Telegram WebApp initialization failed:', error);
        alert('Не удалось инициализировать Telegram WebApp. Откройте через Telegram.');
      }

      // Функция форматирования даты в формат YYYY-MM-DD для API
      function formatDate(date) {
        let d = new Date(date);
        let month = '' + (d.getMonth() + 1);
        let day = '' + d.getDate();
        let year = d.getFullYear();
        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;
        return [year, month, day].join('-');
      }

      // Получение дат недели для вкладок (начиная с понедельника)
      function getWeekDates(selectedDate) {
        let date = new Date(selectedDate);
        let day = date.getDay();
        let diff = (day === 0 ? -6 : 1 - day); // Находим понедельник
        let monday = new Date(date);
        monday.setDate(date.getDate() + diff);
        let weekDates = [];
        for (let i = 0; i < 7; i++) {
          let d = new Date(monday);
          d.setDate(monday.getDate() + i);
          weekDates.push(d);
        }
        return weekDates;
      }

      // Обновление вкладок с датами недели
      function updateTabs(selectedDate) {
        const tabsContainer = document.getElementById('tabsContainer');
        if (!tabsContainer) return;
        tabsContainer.innerHTML = '';
        let weekDates = getWeekDates(selectedDate);
        weekDates.forEach(function(date) {
          let tab = document.createElement('div');
          tab.className = 'tab';
          let dayNames = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
          let dayName = dayNames[date.getDay()];
          let dayNum = date.getDate();
          tab.innerHTML = dayName + '<br>' + dayNum;
          tab.dataset.date = formatDate(date);
          tab.addEventListener('click', function() {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            let today = formatDate(new Date());
            if (tab.dataset.date === today) {
              document.getElementById('currentDay').textContent = 'Сегодня';
            } else {
              document.getElementById('currentDay').textContent = dayName + '. ' + dayNum;
            }
            currentSelectedDate = new Date(tab.dataset.date);
            updateMonthDisplay(currentSelectedDate);
            updateCurrentDayLabel();
            loadTasks(); // Загрузка задач для выбранной даты
          });
          if (formatDate(date) === formatDate(selectedDate)) {
            tab.classList.add('active');
          }
          tabsContainer.appendChild(tab);
        });
      }

      // Текущая выбранная дата (по умолчанию - сегодня)
      let currentSelectedDate = new Date();
      function updateMonthDisplay(date) {
        const monthText = document.getElementById('monthText');
        if (!monthText) return;
        const options = { month: 'long', year: 'numeric' };
        monthText.textContent = date.toLocaleDateString('ru-RU', options);
      }

      updateMonthDisplay(currentSelectedDate);
      updateTabs(currentSelectedDate);

      // Обработчик клика по выбору месяца
      const monthDisplay = document.getElementById('monthDisplay');
      if (monthDisplay) {
        monthDisplay.addEventListener('click', function() {
          document.getElementById('datePicker').click();
        });
      }

      // Обработчик выбора даты через date picker
      const datePicker = document.getElementById('datePicker');
      if (datePicker) {
        datePicker.addEventListener('change', function() {
          let selected = new Date(this.value);
          currentSelectedDate = selected;
          updateMonthDisplay(selected);
          updateTabs(selected);
          updateCurrentDayLabel();
          loadTasks();
        });
      }

      // Переключение на предыдущий день
      const prevDay = document.getElementById('prevDay');
      if (prevDay) {
        prevDay.addEventListener('click', function(e) {
          e.stopPropagation();
          currentSelectedDate.setDate(currentSelectedDate.getDate() - 1);
          updateMonthDisplay(currentSelectedDate);
          updateTabs(currentSelectedDate);
          updateCurrentDayLabel();
          loadTasks();
        });
      }

      // Переключение на следующий день
      const nextDay = document.getElementById('nextDay');
      if (nextDay) {
        nextDay.addEventListener('click', function(e) {
          e.stopPropagation();
          currentSelectedDate.setDate(currentSelectedDate.getDate() + 1);
          updateMonthDisplay(currentSelectedDate);
          updateTabs(currentSelectedDate);
          updateCurrentDayLabel();
          loadTasks();
        });
      }

      // Обновление метки текущего дня
      function updateCurrentDayLabel() {
        const dayNames = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
        const dayName = dayNames[currentSelectedDate.getDay()];
        const dayNum = currentSelectedDate.getDate();
        const today = formatDate(new Date());
        const currentDay = document.getElementById('currentDay');
        if (currentDay) {
          currentDay.textContent = formatDate(currentSelectedDate) === today ? 'Сегодня' : dayName + '. ' + dayNum;
        }
      }

      // Открытие модального окна для создания/редактирования задачи
      let currentTaskItem = null;
      function openModal(taskItem) {
        const modal = document.getElementById('taskForm');
        const backdrop = document.getElementById('backdrop');
        if (!modal || !backdrop) return;
        currentTaskItem = taskItem;
        modal.classList.add('active');
        backdrop.classList.add('active');
        if (taskItem) {
          document.getElementById('modalTaskTitle').textContent = taskItem.dataset.title;
          document.getElementById('modalTaskInput').value = taskItem.dataset.title;
          document.getElementById('modalTaskDesc').value = taskItem.dataset.description || '';
          document.getElementById('modalTaskDate').value = taskItem.dataset.date;
          document.getElementById('modalTaskTime').value = taskItem.dataset.time || '';
          document.getElementById('modalTaskReminder').checked = taskItem.dataset.reminder === "true";
          document.getElementById('modalTaskPriority').value = taskItem.dataset.priority;
          document.getElementById('modalCompleteBtn').textContent = taskItem.dataset.completed === "true" ? "Вернуть" : "Выполнить";
        } else {
          document.getElementById('modalTaskTitle').textContent = "Новая задача";
          document.getElementById('modalTaskInput').value = "";
          document.getElementById('modalTaskDesc').value = "";
          document.getElementById('modalTaskDate').value = formatDate(new Date());
          document.getElementById('modalTaskTime').value = "";
          document.getElementById('modalTaskReminder').checked = false;
          document.getElementById('modalTaskPriority').value = "Medium";
          document.getElementById('modalCompleteBtn').textContent = "Выполнить";
        }
      }

      // Закрытие модального окна с анимацией
      function closeModal() {
        const modal = document.getElementById('taskForm');
        const backdrop = document.getElementById('backdrop');
        if (!modal || !backdrop) return;
        modal.classList.add('closing');
        setTimeout(() => {
          modal.classList.remove('active', 'closing');
          backdrop.classList.remove('active');
        }, 300);
      }

      // Кнопка "Добавить задачу"
      const addTaskBtn = document.getElementById('addTaskBtn');
      if (addTaskBtn) {
        addTaskBtn.addEventListener('click', function() {
          openModal(null);
        });
      }

      // Закрытие модального окна по кнопке "X"
      const closeModalBtn = document.getElementById('closeModalBtn');
      if (closeModalBtn) {
        closeModalBtn.addEventListener('click', closeModal);
      }

      // Закрытие модального окна по клику на фон
      const backdrop = document.getElementById('backdrop');
      if (backdrop) {
        backdrop.addEventListener('click', closeModal);
      }

      // Обновление заголовка задачи в модальном окне при вводе
      const modalTaskInput = document.getElementById('modalTaskInput');
      if (modalTaskInput) {
        modalTaskInput.addEventListener('input', function() {
          document.getElementById('modalTaskTitle').textContent = this.value || 'Задача';
        });
      }

      // Обработчик для кнопки "Выполнить"/"Вернуть"
      const modalCompleteBtn = document.getElementById('modalCompleteBtn');
      if (modalCompleteBtn) {
        modalCompleteBtn.addEventListener('click', async function() {
          if (!currentTaskItem) return; // Если это новая задача, кнопка не активна

          const taskId = currentTaskItem.dataset.id;
          const isCompleted = currentTaskItem.dataset.completed === "true";
          const newCompletedStatus = !isCompleted;

          // Обновляем статус в DOM
          currentTaskItem.dataset.completed = newCompletedStatus;
          currentTaskItem.classList.toggle('completed');
          modalCompleteBtn.textContent = newCompletedStatus ? "Вернуть" : "Выполнить";

          try {
            const response = await fetch(`https://task-manager-tj38.onrender.com/tasks/${taskId}?user_id=${user_id}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ completed: newCompletedStatus })
            });
            if (!response.ok) throw new Error(`Ошибка ${response.status}`);
            const updatedTask = await response.json();
            const taskIndex = visibleTasks.findIndex(t => t.id === parseInt(taskId));
            if (taskIndex !== -1) {
              visibleTasks[taskIndex].completed = updatedTask.completed;
            }
            renderTasks();
          } catch (error) {
            console.error('Ошибка при обновлении статуса задачи:', error);
            alert(`Не удалось обновить статус задачи: ${error.message}`);
            // Откат изменений в случае ошибки
            currentTaskItem.dataset.completed = isCompleted;
            currentTaskItem.classList.toggle('completed');
            modalCompleteBtn.textContent = isCompleted ? "Вернуть" : "Выполнить";
          }
        });
      }

      // Обработка сохранения задачи
      const modalSubmitBtn = document.getElementById('modalSubmitBtn');
      if (modalSubmitBtn) {
        modalSubmitBtn.addEventListener('click', async function() {
          const titleInput = document.getElementById('modalTaskInput');
          const dateInput = document.getElementById('modalTaskDate');
          if (!titleInput.value.trim()) {
            titleInput.style.borderColor = '#BD0935';
            titleInput.focus();
            return;
          }
          if (new Date(dateInput.value) < new Date().setHours(0,0,0,0)) {
            dateInput.style.borderColor = '#BD0935';
            return;
          }

          const title = titleInput.value.trim();
          const description = document.getElementById('modalTaskDesc').value;
          const date = dateInput.value;
          const time = document.getElementById('modalTaskTime').value;
          const deadline = date && time ? `${date}T${time}:00` : date ? `${date}T00:00:00` : null;
          const priority = document.getElementById('modalTaskPriority').value;
          const reminder = document.getElementById('modalTaskReminder').checked;

          if (currentTaskItem) {
            const taskId = currentTaskItem.dataset.id;
            try {
              // Обновляем только поле completed (ограничение текущего API)
              const response = await fetch(`https://task-manager-tj38.onrender.com/tasks/${taskId}?user_id=${user_id}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  completed: currentTaskItem.dataset.completed === "true"
                })
              });
              if (!response.ok) throw new Error(`Ошибка ${response.status}`);
              const updatedTask = await response.json();
              const taskIndex = visibleTasks.findIndex(t => t.id === parseInt(taskId));
              if (taskIndex !== -1) visibleTasks[taskIndex] = updatedTask;
              renderTasks();
            } catch (error) {
              console.error('Ошибка при обновлении задачи:', error);
              alert(`Не удалось обновить задачу: ${error.message}`);
            }
          } else {
            try {
              // POST-запрос для создания новой задачи
              const response = await fetch(`https://task-manager-tj38.onrender.com/tasks?user_id=${user_id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  title,
                  description,
                  deadline,
                  priority,
                  reminder,
                  completed: false
                })
              });
              if (!response.ok) throw new Error(`Ошибка ${response.status}`);
              const newTask = await response.json();
              visibleTasks.push(newTask);
              renderTasks();
            } catch (error) {
              console.error('Ошибка при создании задачи:', error);
              alert(`Не удалось создать задачу: ${error.message}`);
            }
          }
          closeModal();
        });
      }

      // Массив для хранения отображаемых задач
      const visibleTasks = [];
      const taskList = document.getElementById('taskList');

      // Создание элемента задачи
      function createTaskElement(task) {
        const taskItem = document.createElement('div');
        taskItem.className = 'task-item';
        taskItem.dataset.id = task.id;
        taskItem.dataset.title = task.title;
        taskItem.dataset.description = task.description || '';
        taskItem.dataset.date = task.deadline ? task.deadline.split('T')[0] : '';
        taskItem.dataset.time = task.deadline ? task.deadline.split('T')[1]?.slice(0, 5) : '';
        taskItem.dataset.priority = task.priority;
        taskItem.dataset.reminder = task.reminder || false;
        taskItem.dataset.completed = task.completed || false;

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.className = 'checkbox';
        checkbox.checked = task.completed || false;
        if (task.completed) taskItem.classList.add('completed');

        // Обработчик чекбокса для изменения статуса completed
        checkbox.addEventListener('click', async function(event) {
          event.stopPropagation();
          const isCompleted = checkbox.checked;
          taskItem.classList.toggle('completed');
          taskItem.dataset.completed = isCompleted;

          try {
            const taskId = taskItem.dataset.id;
            const response = await fetch(`https://task-manager-tj38.onrender.com/tasks/${taskId}?user_id=${user_id}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ completed: isCompleted })
            });
            if (!response.ok) throw new Error(`Ошибка ${response.status}`);
            const updatedTask = await response.json();
            const taskIndex = visibleTasks.findIndex(t => t.id === parseInt(taskId));
            if (taskIndex !== -1) visibleTasks[taskIndex].completed = updatedTask.completed;
            renderTasks();
          } catch (error) {
            console.error('Ошибка при обновлении задачи:', error);
            alert(`Не удалось обновить задачу: ${error.message}`);
            checkbox.checked = !isCompleted;
            taskItem.classList.toggle('completed');
            taskItem.dataset.completed = !isCompleted;
          }
        });

        const taskInfo = document.createElement('div');
        taskInfo.className = 'task-info';
        const titleElem = document.createElement('div');
        titleElem.className = 'task-title';
        titleElem.textContent = task.title;
        const dateElem = document.createElement('div');
        dateElem.className = 'task-date';
        dateElem.textContent = task.deadline 
          ? new Date(task.deadline).toLocaleString('ru-RU', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }) 
          : 'Без даты';
        taskInfo.appendChild(titleElem);
        taskInfo.appendChild(dateElem);

        const priorityElem = document.createElement('div');
        priorityElem.className = 'priority';
        if (task.priority === 'High') priorityElem.classList.add('priority-high');
        else if (task.priority === 'Medium') priorityElem.classList.add('priority-medium');
        else priorityElem.classList.add('priority-low');
        priorityElem.textContent = task.priority === 'High' ? 'Высокий' : task.priority === 'Medium' ? 'Средний' : 'Низкий';

        // Кнопка удаления задачи
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.textContent = 'Удалить';
        deleteBtn.addEventListener('click', async function(event) {
          event.stopPropagation();
          const taskId = task.id;
          try {
            const response = await fetch(`https://task-manager-tj38.onrender.com/tasks/${taskId}?user_id=${user_id}`, {
              method: 'DELETE',
            });
            if (!response.ok) throw new Error(`Ошибка ${response.status}`);
            const index = visibleTasks.findIndex(t => t.id === taskId);
            if (index !== -1) visibleTasks.splice(index, 1);
            renderTasks();
          } catch (error) {
            console.error('Ошибка при удалении задачи:', error);
            alert(`Не удалось удалить задачу: ${error.message}`);
          }
        });

        taskItem.appendChild(checkbox);
        taskItem.appendChild(taskInfo);
        taskItem.appendChild(priorityElem);
        taskItem.appendChild(deleteBtn);

        // Открытие модального окна при клике на задачу
        taskItem.addEventListener('click', function() {
          openModal(taskItem);
        });

        return taskItem;
      }

      // Рендеринг списка задач
      function renderTasks() {
        if (!taskList) return;
        taskList.innerHTML = '';
        visibleTasks.forEach(task => {
          taskList.appendChild(createTaskElement(task));
        });
      }

      // Загрузка задач с сервера
      async function loadTasks() {
        try {
          const selectedDate = formatDate(currentSelectedDate);
          const response = await fetch(`https://task-manager-tj38.onrender.com/tasks?user_id=${user_id}&date=${selectedDate}`, {
            method: 'GET',
            headers: { 'Content-Type': 'application/json' },
          });
          if (!response.ok) throw new Error(`Ошибка ${response.status}`);
          const tasks = await response.json();
          visibleTasks.length = 0; // Очистка перед загрузкой
          tasks.forEach(task => visibleTasks.push(task));
          renderTasks();
        } catch (error) {
          console.error('Ошибка при загрузке задач:', error);
          alert(`Не удалось загрузить задачи: ${error.message}`);
        }
      }

      // Первоначальная загрузка задач
      loadTasks();
    });
  </script>
</body>
</html>
